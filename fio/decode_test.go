package fio

import (
	"strings"
	"testing"
)

var input string = `
{
  "fio version" : "fio-2.2.10",
  "timestamp" : 1499464001,
  "time" : "Fri Jul  7 21:46:41 2017",
  "jobs" : [
    {
      "jobname" : "job1",
      "groupid" : 0,
      "error" : 0,
      "eta" : 0,
      "elapsed" : 11,
      "read" : {
        "io_bytes" : 87204,
        "bw" : 8719,
        "iops" : 2179.88,
        "runtime" : 10001,
        "total_ios" : 21801,
        "short_ios" : 0,
        "drop_ios" : 0,
        "slat" : {
          "min" : 261,
          "max" : 11239,
          "mean" : 454.57,
          "stddev" : 178.87
        },
        "clat" : {
          "min" : 2,
          "max" : 57514,
          "mean" : 28825.67,
          "stddev" : 3668.11,
          "percentile" : {
            "1.000000" : 25216,
            "5.000000" : 25728,
            "10.000000" : 25984,
            "20.000000" : 26496,
            "30.000000" : 26752,
            "40.000000" : 27264,
            "50.000000" : 27776,
            "60.000000" : 28544,
            "70.000000" : 29568,
            "80.000000" : 30336,
            "90.000000" : 32640,
            "95.000000" : 35072,
            "99.000000" : 43776,
            "99.500000" : 47360,
            "99.900000" : 55552,
            "99.950000" : 56576,
            "99.990000" : 57088,
            "0.00" : 0,
            "0.00" : 0,
            "0.00" : 0
          }
        },
        "lat" : {
          "min" : 473,
          "max" : 57895,
          "mean" : 29280.97,
          "stddev" : 3706.39
        },
        "bw_min" : 7464,
        "bw_max" : 9472,
        "bw_agg" : 27.92,
        "bw_mean" : 8729.26,
        "bw_dev" : 634.33
      },
      "write" : {
        "io_bytes" : 0,
        "bw" : 0,
        "iops" : 0.00,
        "runtime" : 0,
        "total_ios" : 0,
        "short_ios" : 0,
        "drop_ios" : 0,
        "slat" : {
          "min" : 0,
          "max" : 0,
          "mean" : 0.00,
          "stddev" : 0.00
        },
        "clat" : {
          "min" : 0,
          "max" : 0,
          "mean" : 0.00,
          "stddev" : 0.00,
          "percentile" : {
            "1.000000" : 0,
            "5.000000" : 0,
            "10.000000" : 0,
            "20.000000" : 0,
            "30.000000" : 0,
            "40.000000" : 0,
            "50.000000" : 0,
            "60.000000" : 0,
            "70.000000" : 0,
            "80.000000" : 0,
            "90.000000" : 0,
            "95.000000" : 0,
            "99.000000" : 0,
            "99.500000" : 0,
            "99.900000" : 0,
            "99.950000" : 0,
            "99.990000" : 0,
            "0.00" : 0,
            "0.00" : 0,
            "0.00" : 0
          }
        },
        "lat" : {
          "min" : 0,
          "max" : 0,
          "mean" : 0.00,
          "stddev" : 0.00
        },
        "bw_min" : 0,
        "bw_max" : 0,
        "bw_agg" : 0.00,
        "bw_mean" : 0.00,
        "bw_dev" : 0.00
      },
      "trim" : {
        "io_bytes" : 0,
        "bw" : 0,
        "iops" : 0.00,
        "runtime" : 0,
        "total_ios" : 0,
        "short_ios" : 0,
        "drop_ios" : 0,
        "slat" : {
          "min" : 0,
          "max" : 0,
          "mean" : 0.00,
          "stddev" : 0.00
        },
        "clat" : {
          "min" : 0,
          "max" : 0,
          "mean" : 0.00,
          "stddev" : 0.00,
          "percentile" : {
            "1.000000" : 0,
            "5.000000" : 0,
            "10.000000" : 0,
            "20.000000" : 0,
            "30.000000" : 0,
            "40.000000" : 0,
            "50.000000" : 0,
            "60.000000" : 0,
            "70.000000" : 0,
            "80.000000" : 0,
            "90.000000" : 0,
            "95.000000" : 0,
            "99.000000" : 0,
            "99.500000" : 0,
            "99.900000" : 0,
            "99.950000" : 0,
            "99.990000" : 0,
            "0.00" : 0,
            "0.00" : 0,
            "0.00" : 0
          }
        },
        "lat" : {
          "min" : 0,
          "max" : 0,
          "mean" : 0.00,
          "stddev" : 0.00
        },
        "bw_min" : 0,
        "bw_max" : 0,
        "bw_agg" : 0.00,
        "bw_mean" : 0.00,
        "bw_dev" : 0.00
      },
      "usr_cpu" : 0.96,
      "sys_cpu" : 2.24,
      "ctx" : 21874,
      "majf" : 0,
      "minf" : 71,
      "iodepth_level" : {
        "1" : 0.10,
        "2" : 0.10,
        "4" : 0.10,
        "8" : 0.10,
        "16" : 0.10,
        "32" : 0.15,
        ">=64" : 99.71
      },
      "latency_us" : {
        "2" : 0.00,
        "4" : 0.01,
        "10" : 0.00,
        "20" : 0.00,
        "50" : 0.00,
        "100" : 0.00,
        "250" : 0.00,
        "500" : 0.01,
        "750" : 0.00,
        "1000" : 0.01
      },
      "latency_ms" : {
        "2" : 0.01,
        "4" : 0.01,
        "10" : 0.06,
        "20" : 0.09,
        "50" : 99.43,
        "100" : 0.39,
        "250" : 0.00,
        "500" : 0.00,
        "750" : 0.00,
        "1000" : 0.00,
        "2000" : 0.00,
        ">=2000" : 0.00
      },
      "latency_depth" : 64,
      "latency_target" : 0,
      "latency_percentile" : 100.00,
      "latency_window" : 0
    },
    {
      "jobname" : "job2",
      "groupid" : 0,
      "error" : 0,
      "eta" : 0,
      "elapsed" : 11,
      "read" : {
        "io_bytes" : 225504,
        "bw" : 22548,
        "iops" : 5637.04,
        "runtime" : 10001,
        "total_ios" : 56376,
        "short_ios" : 0,
        "drop_ios" : 0,
        "slat" : {
          "min" : 16,
          "max" : 9139,
          "mean" : 173.67,
          "stddev" : 94.21
        },
        "clat" : {
          "min" : 2,
          "max" : 45824,
          "mean" : 11141.15,
          "stddev" : 1462.96,
          "percentile" : {
            "1.000000" : 9792,
            "5.000000" : 10048,
            "10.000000" : 10176,
            "20.000000" : 10432,
            "30.000000" : 10560,
            "40.000000" : 10688,
            "50.000000" : 10816,
            "60.000000" : 11072,
            "70.000000" : 11200,
            "80.000000" : 11584,
            "90.000000" : 12480,
            "95.000000" : 13248,
            "99.000000" : 14912,
            "99.500000" : 15424,
            "99.900000" : 39680,
            "99.950000" : 43776,
            "99.990000" : 45824,
            "0.00" : 0,
            "0.00" : 0,
            "0.00" : 0
          }
        },
        "lat" : {
          "min" : 182,
          "max" : 46022,
          "mean" : 11315.43,
          "stddev" : 1476.10
        },
        "bw_min" : 18952,
        "bw_max" : 23736,
        "bw_agg" : 71.79,
        "bw_mean" : 22446.32,
        "bw_dev" : 1248.91
      },
      "write" : {
        "io_bytes" : 0,
        "bw" : 0,
        "iops" : 0.00,
        "runtime" : 0,
        "total_ios" : 0,
        "short_ios" : 0,
        "drop_ios" : 0,
        "slat" : {
          "min" : 0,
          "max" : 0,
          "mean" : 0.00,
          "stddev" : 0.00
        },
        "clat" : {
          "min" : 0,
          "max" : 0,
          "mean" : 0.00,
          "stddev" : 0.00,
          "percentile" : {
            "1.000000" : 0,
            "5.000000" : 0,
            "10.000000" : 0,
            "20.000000" : 0,
            "30.000000" : 0,
            "40.000000" : 0,
            "50.000000" : 0,
            "60.000000" : 0,
            "70.000000" : 0,
            "80.000000" : 0,
            "90.000000" : 0,
            "95.000000" : 0,
            "99.000000" : 0,
            "99.500000" : 0,
            "99.900000" : 0,
            "99.950000" : 0,
            "99.990000" : 0,
            "0.00" : 0,
            "0.00" : 0,
            "0.00" : 0
          }
        },
        "lat" : {
          "min" : 0,
          "max" : 0,
          "mean" : 0.00,
          "stddev" : 0.00
        },
        "bw_min" : 0,
        "bw_max" : 0,
        "bw_agg" : 0.00,
        "bw_mean" : 0.00,
        "bw_dev" : 0.00
      },
      "trim" : {
        "io_bytes" : 0,
        "bw" : 0,
        "iops" : 0.00,
        "runtime" : 0,
        "total_ios" : 0,
        "short_ios" : 0,
        "drop_ios" : 0,
        "slat" : {
          "min" : 0,
          "max" : 0,
          "mean" : 0.00,
          "stddev" : 0.00
        },
        "clat" : {
          "min" : 0,
          "max" : 0,
          "mean" : 0.00,
          "stddev" : 0.00,
          "percentile" : {
            "1.000000" : 0,
            "5.000000" : 0,
            "10.000000" : 0,
            "20.000000" : 0,
            "30.000000" : 0,
            "40.000000" : 0,
            "50.000000" : 0,
            "60.000000" : 0,
            "70.000000" : 0,
            "80.000000" : 0,
            "90.000000" : 0,
            "95.000000" : 0,
            "99.000000" : 0,
            "99.500000" : 0,
            "99.900000" : 0,
            "99.950000" : 0,
            "99.990000" : 0,
            "0.00" : 0,
            "0.00" : 0,
            "0.00" : 0
          }
        },
        "lat" : {
          "min" : 0,
          "max" : 0,
          "mean" : 0.00,
          "stddev" : 0.00
        },
        "bw_min" : 0,
        "bw_max" : 0,
        "bw_agg" : 0.00,
        "bw_mean" : 0.00,
        "bw_dev" : 0.00
      },
      "usr_cpu" : 2.04,
      "sys_cpu" : 17.08,
      "ctx" : 55165,
      "majf" : 0,
      "minf" : 71,
      "iodepth_level" : {
        "1" : 0.10,
        "2" : 0.10,
        "4" : 0.10,
        "8" : 0.10,
        "16" : 0.10,
        "32" : 0.10,
        ">=64" : 99.89
      },
      "latency_us" : {
        "2" : 0.00,
        "4" : 0.01,
        "10" : 0.00,
        "20" : 0.00,
        "50" : 0.00,
        "100" : 0.00,
        "250" : 0.01,
        "500" : 0.01,
        "750" : 0.01,
        "1000" : 0.01
      },
      "latency_ms" : {
        "2" : 0.01,
        "4" : 0.02,
        "10" : 3.76,
        "20" : 96.08,
        "50" : 0.12,
        "100" : 0.00,
        "250" : 0.00,
        "500" : 0.00,
        "750" : 0.00,
        "1000" : 0.00,
        "2000" : 0.00,
        ">=2000" : 0.00
      },
      "latency_depth" : 64,
      "latency_target" : 0,
      "latency_percentile" : 100.00,
      "latency_window" : 0
    }
  ]
}
`

func TestDecode(t *testing.T) {

	reader := strings.NewReader(input)

	report, err := Decode(reader)
	if err != nil {
		t.Fatalf("failed to decode: %v", err)
	}

	if report.FIOVersion != "fio-2.2.10" {
		t.Errorf("got %s, expected %s", report.FIOVersion, "fio-2.2.10")
	}
	if report.Timestamp != 1499464001 {
		t.Errorf("got %d, expected %d", report.Timestamp, 1499464001)
	}

	if len(report.Jobs) != 2 {
		t.Errorf("expected 2 jobs, got %d", len(report.Jobs))
	}

	for _, job := range report.Jobs {
		if job.JobName != "job1" && job.JobName != "job2" {
			t.Errorf("expected job name %s or %s, got %s", "storageos", "native", job.JobName)
		}
		if job.Read == nil {
			t.Errorf("expected read stats")
		}
		if job.Write == nil {
			t.Errorf("expected write stats")
		}
		if job.Trim == nil {
			t.Errorf("expected trim stats")
		}
	}
}
